<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Выбор раздела</title>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { font-family: sans-serif; background-color: #f9f4ef; padding: 40px; }
    select, button { margin: 10px 0; padding: 8px; font-size: 16px; }
    .placeholder { color: #999; font-style: italic; margin-top: 20px; }
    .section-image { max-width: 80%; margin-bottom: 20px; border-radius: 6px; }
    audio, video { width: 100%; margin-bottom: 20px; }
  </style>
</head>
<body>

  <h1>Выберите сборник и раздел</h1>
  <select id="book-select"><option>Загрузка...</option></select>
  <select id="section-select" disabled><option>Сначала выберите сборник</option></select>
  <button onclick="loadSelected()">Открыть</button>

  <div id="content" class="placeholder">Раздел не загружен.</div>
  <div id="media"></div>

  <script>
    let library = {};

    fetch("library.json")
      .then(res => res.json())
      .then(data => {
        library = data;
        const bookSelect = document.getElementById("book-select");
        bookSelect.innerHTML = `<option disabled selected>Выберите сборник</option>` +
          Object.keys(library).map(book => `<option value="${book}">${book}</option>`).join("");

        bookSelect.onchange = () => {
          const selectedBook = bookSelect.value;
          const sectionSelect = document.getElementById("section-select");
          const sections = Object.keys(library[selectedBook].sections || {});
          sectionSelect.disabled = false;
          sectionSelect.innerHTML = `<option disabled selected>Выберите раздел</option>` +
            sections.map(s => `<option value="${s}">${s}</option>`).join("");
        };
      });

    function loadSelected() {
      const book = document.getElementById("book-select").value;
      const section = document.getElementById("section-select").value;
      const docPath = library[book]?.sections?.[section];

      if (!docPath) {
        document.getElementById("content").innerHTML = `<p class="placeholder">Раздел не найден.</p>`;
        return;
      }

      fetch(docPath)
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => mammoth.convertToHtml({ arrayBuffer }))
        .then(result => {
          const html = result.value;
          const poems = html.split("<p>").filter(p => p.trim().length > 0);
          const illustrationPath = `images/${section.toLowerCase().replace(/ /g,"-")}-illustration.jpg`;

          document.getElementById("content").innerHTML = `
            <img src="${illustrationPath}" class="section-image" onerror="this.style.display='none'">
            <div id="poem-text"><p>${poems.map(p => p.trim()).join("</p><p>")}</p></div>
          `;

          const title = normalizeTitle(section);
          const audioPath = `audio/${title}.mp3`;
          const videoPath = `video/${title}.mp4`;

          checkMedia(audioPath, "АУДИО ФАЙЛ ОТСУТСТВУЕТ", "audio");
          checkMedia(videoPath, "ВИДЕО ФАЙЛ ОТСУТСТВУЕТ", "video");
        })
        .catch(err => {
          document.getElementById("content").innerHTML = `<p class="placeholder">Ошибка загрузки: ${err.message}</p>`;
        });
    }

    function normalizeTitle(title) {
      return title.toLowerCase().replace(/[^а-яa-z0-9]/gi, "-");
    }

    function checkMedia(path, fallback, type) {
      fetch(path).then(res => {
        document.getElementById("media").innerHTML =
          res.ok
            ? (type === "audio" ? `<audio controls src="${path}"></audio>` : `<video controls src="${path}"></video>`)
            : `<p class="placeholder">${fallback}</p>`;
      }).catch(() => {
        document.getElementById("media").innerHTML = `<p class="placeholder">${fallback}</p>`;
      });
    }
  </script>

</body>
</html>
