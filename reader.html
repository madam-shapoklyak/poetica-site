<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ß—Ç–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞</title>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { display: flex; margin: 0; font-family: sans-serif; background-color: #f9f4ef; }
    .sidebar, .content, .media { padding: 20px; height: 100vh; overflow-y: auto; }
    .sidebar { width: 25%; background-color: #fff8f0; border-right: 1px solid #ccc; }
    .content { width: 50%; text-align: center; }
    .media { width: 25%; background-color: #fff8f0; border-left: 1px solid #ccc; }
    .poem-list li { margin: 10px 0; cursor: pointer; color: #5a3e36; }
    .poem-list li:hover { text-decoration: underline; }
    .section-image { max-width: 80%; margin-bottom: 20px; border-radius: 6px; }
    audio, video { width: 100%; margin-bottom: 20px; }
    .placeholder { color: #999; font-style: italic; }
  </style>
</head>
<body>

  <div class="sidebar" id="sidebar"></div>
  <div class="content" id="content"></div>
  <div class="media" id="media"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const book = params.get("book")?.trim();
    const section = params.get("section")?.trim();

    console.log("üìò book:", book);
    console.log("üìó section:", section);

    fetch("library.json")
      .then(res => res.json())
      .then(library => {
        console.log("üìö library keys:", Object.keys(library));

        if (!library[book]) {
          document.body.innerHTML = `<p style="padding:40px;">–°–±–æ—Ä–Ω–∏–∫ "${book}" –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>`;
          return;
        }

        const sectionKeys = Object.keys(library[book].sections || {});
        console.log("üìñ sections in book:", sectionKeys);

        let docPath = null;
        for (const key of sectionKeys) {
          console.log(`üîç –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: "${key}" === "${section}" ‚Üí`, key === section);
          if (key.trim() === section) {
            docPath = library[book].sections[key];
            break;
          }
        }

        console.log("üìÑ docPath –Ω–∞–π–¥–µ–Ω:", docPath);

        if (!docPath) {
          document.body.innerHTML = `<p style="padding:40px;">–†–∞–∑–¥–µ–ª "${section}" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–±–æ—Ä–Ω–∏–∫–µ "${book}".</p>`;
          return;
        }

        fetch(docPath)
          .then(response => response.arrayBuffer())
          .then(arrayBuffer => mammoth.convertToHtml({ arrayBuffer }))
          .then(result => {
            const html = result.value;
            const poems = html.split("<p>").filter(p => p.trim().length > 0);

            const coverPath = `images/${book.toLowerCase().replace(/ /g,"-")}-cover.jpg`;
            const illustrationPath = `images/${section.toLowerCase().replace(/ /g,"-")}-illustration.jpg`;

            document.getElementById("sidebar").innerHTML = `
              <img src="${coverPath}" style="width:100%; border-radius:6px;" onerror="this.src='images/placeholder.jpg'">
              <h2>${section}</h2>
              <ul class="poem-list">
                ${poems.map((p, i) => `<li onclick="showPoem(${i})">${extractTitle(p)}</li>`).join("")}
              </ul>
            `;

            document.getElementById("content").innerHTML = `
              <img src="${illustrationPath}" class="section-image" onerror="this.style.display='none'">
              <div id="poem-text"><p class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏—Ö –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞</p></div>
            `;

            document.getElementById("media").innerHTML = `
              <div id="audio-block"><p class="placeholder">–ê–£–î–ò–û –§–ê–ô–õ –û–¢–°–£–¢–°–¢–í–£–ï–¢</p></div>
              <div id="video-block"><p class="placeholder">–í–ò–î–ï–û –§–ê–ô–õ –û–¢–°–£–¢–°–¢–í–£–ï–¢</p></div>
            `;

            window.showPoem = function(index) {
              const poemHtml = poems[index];
              const title = normalizeTitle(extractTitle(poemHtml));
              document.getElementById("poem-text").innerHTML = `<h3>${title}</h3><p>${stripTags(poemHtml)}</p>`;

              const audioPath = `audio/${title}.mp3`;
              const videoPath = `video/${title}.mp4`;

              checkMedia(audioPath, "audio-block", "–ê–£–î–ò–û –§–ê–ô–õ –û–¢–°–£–¢–°–¢–í–£–ï–¢", "audio");
              checkMedia(videoPath, "video-block", "–í–ò–î–ï–û –§–ê–ô–õ –û–¢–°–£–¢–°–¢–í–£–ï–¢", "video");
            };

            function extractTitle(html) {
              return html.replace(/<[^>]+>/g, "").split("\n")[0].trim();
            }

            function normalizeTitle(title) {
              return title.toLowerCase().replace(/[^–∞-—èa-z0-9]/gi, "-");
            }

            function stripTags(html) {
              return html.replace(/<[^>]+>/g, "").trim();
            }

            function checkMedia(path, blockId, fallback, type) {
              fetch(path).then(res => {
                if (res.ok) {
                  document.getElementById(blockId).innerHTML =
                    type === "audio" ? `<audio controls src="${path}"></audio>` :
                    `<video controls src="${path}"></video>`;
                } else {
                  document.getElementById(blockId).innerHTML = `<p class="placeholder">${fallback}</p>`;
                }
              }).catch(() => {
                document.getElementById(blockId).innerHTML = `<p class="placeholder">${fallback}</p>`;
              });
            }
          })
          .catch(err => {
            document.body.innerHTML = `<p style="padding:40px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${err.message}</p>`;
          });
      })
      .catch(() => {
        document.body.innerHTML = `<p style="padding:40px;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É.</p>`;
      });
  </script>

</body>
</html>
