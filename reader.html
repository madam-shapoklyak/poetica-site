<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Чтение раздела</title>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <style>
    body { display: flex; margin: 0; font-family: sans-serif; background-color: #f9f4ef; }
    .sidebar, .content, .media { padding: 20px; height: 100vh; overflow-y: auto; }
    .sidebar { width: 25%; background-color: #fff8f0; border-right: 1px solid #ccc; }
    .content { width: 50%; text-align: center; }
    .media { width: 25%; background-color: #fff8f0; border-left: 1px solid #ccc; }
    .poem-list li { margin: 10px 0; cursor: pointer; color: #5a3e36; }
    .poem-list li:hover { text-decoration: underline; }
    .section-image { max-width: 80%; margin-bottom: 20px; border-radius: 6px; }
    audio, video { width: 100%; margin-bottom: 20px; }
    .placeholder { color: #999; font-style: italic; }
  </style>
</head>
<body>

  <div class="sidebar" id="sidebar"></div>
  <div class="content" id="content"></div>
  <div class="media" id="media"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const book = params.get("book");
    const section = params.get("section");

    const docxPath = `СТИХИ/${book}/${section}/${section.split(" ")[1].toLowerCase()}.docx`;

    fetch(docxPath)
      .then(response => response.arrayBuffer())
      .then(arrayBuffer => mammoth.convertToHtml({ arrayBuffer }))
      .then(result => {
        const html = result.value;
        const poems = html.split("<p>").filter(p => p.trim().length > 0);

        document.getElementById("sidebar").innerHTML = `
          <img src="Изображения/${book.toLowerCase().replace(/ /g,"-")}-cover.jpg" style="width:100%; border-radius:6px;">
          <h2>${section}</h2>
          <ul class="poem-list">
            ${poems.map((p, i) => `<li onclick="showPoem(${i})">${extractTitle(p)}</li>`).join("")}
          </ul>
        `;

        document.getElementById("content").innerHTML = `
          <img src="Изображения/${section.toLowerCase().replace(/ /g,"-")}-illustration.jpg" class="section-image">
          <div id="poem-text"><p class="placeholder">Выберите стих из списка слева</p></div>
        `;

        document.getElementById("media").innerHTML = `
          <div id="audio-block"><p class="placeholder">АУДИО ФАЙЛ ОТСУТСТВУЕТ</p></div>
          <div id="video-block"><p class="placeholder">ВИДЕО ФАЙЛ ОТСУТСТВУЕТ</p></div>
        `;

        window.showPoem = function(index) {
          const poemHtml = poems[index];
          const title = extractTitle(poemHtml);
          document.getElementById("poem-text").innerHTML = `<h3>${title}</h3><p>${stripTags(poemHtml)}</p>`;

          const audioPath = `audio/${title}.mp3`;
          const videoPath = `video/${title}.mp4`;

          checkMedia(audioPath, "audio-block", "АУДИО ФАЙЛ ОТСУТСТВУЕТ", "audio");
          checkMedia(videoPath, "video-block", "ВИДЕО ФАЙЛ ОТСУТСТВУЕТ", "video");
        };

        function extractTitle(html) {
          return html.replace(/<[^>]+>/g, "").split("\n")[0].trim();
        }

        function stripTags(html) {
          return html.replace(/<[^>]+>/g, "").trim();
        }

        function checkMedia(path, blockId, fallback, type) {
          fetch(path).then(res => {
            if (res.ok) {
              document.getElementById(blockId).innerHTML =
                type === "audio" ? `<audio controls src="${path}"></audio>` :
                `<video controls src="${path}"></video>`;
            } else {
              document.getElementById(blockId).innerHTML = `<p class="placeholder">${fallback}</p>`;
            }
          }).catch(() => {
            document.getElementById(blockId).innerHTML = `<p class="placeholder">${fallback}</p>`;
          });
        }
      })
      .catch(err => {
        document.body.innerHTML = `<p style="padding:40px;">Ошибка загрузки файла: ${err.message}</p>`;
      });
  </script>

</body>
</html>
