<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Чтение раздела</title>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { display: flex; margin: 0; font-family: sans-serif; background-color: #f9f4ef; }
    .sidebar, .content, .media { padding: 20px; height: 100vh; overflow-y: auto; }
    .sidebar { width: 25%; background-color: #fff8f0; border-right: 1px solid #ccc; }
    .content { width: 50%; text-align: center; }
    .media { width: 25%; background-color: #fff8f0; border-left: 1px solid #ccc; }
    .poem-list li { margin: 10px 0; cursor: pointer; color: #5a3e36; }
    .poem-list li:hover { text-decoration: underline; }
    .section-image { max-width: 80%; margin-bottom: 20px; border-radius: 6px; }
    audio, video { width: 100%; margin-bottom: 20px; }
    .placeholder { color: #999; font-style: italic; }
  </style>
</head>
<body>

  <div class="sidebar" id="sidebar"></div>
  <div class="content" id="content"></div>
  <div class="media" id="media"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const book = params.get("book")?.trim();
    const section = params.get("section")?.trim();

    console.log("book:", book ?? "не передан");
    console.log("section:", section ?? "не передан");

    if (!book || !section) {
      document.body.innerHTML = `<p style="padding:40px;">Пожалуйста, выберите сборник и раздел в URL.<br><br>
      Пример: <code>?book=МОЗАИКА БУКВ&section=2 МОЗАИКА БУКВ</code></p>`;
    } else {
      fetch("library.json")
        .then(res => res.json())
        .then(library => {
          console.log("library keys:", Object.keys(library));
          console.log("sections in book:", Object.keys((library[book] && library[book].sections) || {}));

          let docPath = null;
          for (const key of Object.keys((library[book] && library[book].sections) || {})) {
            if (key.trim() === section) {
              docPath = library[book].sections[key];
              break;
            }
          }

          console.log("docPath:", docPath);

          if (!docPath) {
            document.body.innerHTML = `<p style="padding:40px;">Раздел "${section}" не найден в сборнике "${book}".</p>`;
            return;
          }

          fetch(docPath)
            .then(response => response.arrayBuffer())
            .then(arrayBuffer => mammoth.convertToHtml({ arrayBuffer }, {
              styleMap: [
                "heading 1 => h1",
                "heading 2 => h2",
                "heading 3 => h3"
              ]
            }))
            .then(result => {
              const blocks = result.value.split("***").map(b => b.trim()).filter(b => b.length > 0);

              const coverPath = `images/${book.toLowerCase().replace(/ /g,"-")}-cover.jpg`;
              const illustrationPath = `images/${section.toLowerCase().replace(/ /g,"-")}-illustration.jpg`;

              document.getElementById("sidebar").innerHTML = `
                <img src="${coverPath}" style="width:100%; border-radius:6px;" onerror="this.src='images/placeholder.jpg'">
                <h2>${section}</h2>
                <ul class="poem-list">
                  ${blocks.map((b, i) => `<li onclick="showPoem(${i})">${extractTitleFromBlock(b)}</li>`).join("")}
                </ul>
              `;

              document.getElementById("content").innerHTML = `
                <img src="${illustrationPath}" class="section-image" onerror="this.style.display='none'">
                <div id="poem-text"><p class="placeholder">Выберите стих из списка слева</p></div>
              `;

              document.getElementById("media").innerHTML = `
                <div id="audio-block"><p class="placeholder">АУДИО ФАЙЛ ОТСУТСТВУЕТ</p></div>
                <div id="video-block"><p class="placeholder">ВИДЕО ФАЙЛ ОТСУТСТВУЕТ</p></div>
              `;

              window.showPoem = function(index) {
                const blockHtml = blocks[index];
                const title = extractTitleFromBlock(blockHtml);
                document.getElementById("poem-text").innerHTML = `<h3>${title}</h3><div>${blockHtml}</div>`;

                const mediaTitle = normalizeTitle(title);
                checkMedia(`audio/${mediaTitle}.mp3`, "audio-block", "АУДИО ФАЙЛ ОТСУТСТВУЕТ", "audio");
                checkMedia(`video/${mediaTitle}.mp4`, "video-block", "ВИДЕО ФАЙЛ ОТСУТСТВУЕТ", "video");
              };

              function extractTitleFromBlock(blockHtml) {
                const temp = document.createElement("div");
                temp.innerHTML = blockHtml;

                const heading = temp.querySelector("h1,h2,h3");
                if (heading) return heading.textContent.trim();

                const firstLine = temp.textContent.split("\n").find(line => line.trim().length > 0);
                return firstLine?.trim() || "Без названия";
              }

              function normalizeTitle(title) {
                return title.toLowerCase().replace(/[^а-яa-z0-9]/gi, "-");
              }

              function checkMedia(path, blockId, fallback, type) {
                fetch(path).then(res => {
                  if (res.ok) {
                    document.getElementById(blockId).innerHTML =
                      type === "audio" ? `<audio controls src="${path}"></audio>` :
                      `<video controls src="${path}"></video>`;
                  } else {
                    document.getElementById(blockId).innerHTML = `<p class="placeholder">${fallback}</p>`;
                  }
                }).catch(() => {
                  document.getElementById(blockId).innerHTML = `<p class="placeholder">${fallback}</p>`;
                });
              }
            })
            .catch(err => {
              document.body.innerHTML = `<p style="padding:40px;">Ошибка загрузки файла: ${err.message}</p>`;
            });
        })
        .catch(() => {
          document.body.innerHTML = `<p style="padding:40px;">Не удалось загрузить библиотеку.</p>`;
        });
    }
  </script>

</body>
</html>
