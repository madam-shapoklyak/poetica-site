<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ß—Ç–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞</title>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; background-color: #f9f4ef; }
    header {
      background-color: #e8dfd1;
      padding: 20px 0;
      text-align: center;
      border-bottom: 1px solid #ccc;
    }
    header h1 {
      margin: 0;
      font-size: 24px;
      color: #5a3e36;
    }
    nav {
      margin-top: 10px;
    }
    nav a {
      margin: 0 15px;
      text-decoration: none;
      color: #5a3e36;
      font-weight: bold;
    }
    nav a:hover {
      text-decoration: underline;
    }
    .main { display: flex; height: calc(100vh - 120px); }
    .sidebar, .content, .media { padding: 20px; overflow-y: auto; }
    .sidebar { width: 25%; background-color: #fff8f0; border-right: 1px solid #ccc; }
    .content { width: 50%; text-align: center; position: relative; }
    .media { width: 25%; background-color: #fff8f0; border-left: 1px solid #ccc; }
    .poem-list li { margin: 10px 0; cursor: pointer; color: #5a3e36; }
    .poem-list li:hover { text-decoration: underline; }
    .section-image { max-width: 80%; margin-bottom: 20px; border-radius: 6px; }
    audio, video { width: 100%; margin-bottom: 20px; }
    .placeholder { color: #999; font-style: italic; }

    /* –°—Ç–∏—Ö–∏ */
    pre {
      white-space: pre-wrap;
      text-align: left;
      font-size: 1.8em;
      line-height: 0.8;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    h3 {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    /* –í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ */
    .poem-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .poem-background {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      background-image: url('./–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/logo.png');
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
      opacity: 0.05;
      pointer-events: none;
      z-index: 0;
      width: 80%;
      height: 100%;
    }
    .poem-content {
      position: relative;
      z-index: 1;
    }
  </style>
</head>
<body>
  <header>
    <h1>–¢–í–û–†–ß–ï–°–ö–ê–Ø –°–¢–£–î–ò–Ø "–°–¢–ê–†–´–ô –ß–ï–ú–û–î–ê–ù–ß–ò–ö"</h1>
    <nav>
      <a href="./index.html">–ì–õ–ê–í–ù–ê–Ø</a>
      <a href="./—Å—Ç–∏—Ö–∏.html">–°–¢–ò–•–ò</a>
      <a href="./–ø—Ä–æ–∑–∞.html">–ü–†–û–ó–ê</a>
      <a href="./–∞—É–¥–∏–æ.html">–ê–£–î–ò–û</a>
      <a href="./–≤–∏–¥–µ–æ.html">–í–ò–î–ï–û</a>
    </nav>
  </header>

  <div class="main">
    <div class="sidebar" id="sidebar"></div>
    <div class="content" id="content"></div>
    <div class="media" id="media"></div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const book = params.get("book")?.trim();
    const section = params.get("section")?.trim();

    if (!book || !section) {
      document.body.innerHTML = `<p style="padding:40px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–±–æ—Ä–Ω–∏–∫ –∏ —Ä–∞–∑–¥–µ–ª –≤ URL.<br><br> –ü—Ä–∏–º–µ—Ä: <code>?book=–ú–û–ó–ê–ò–ö–ê –ë–£–ö–í&section=2 –ú–û–ó–ê–ò–ö–ê –ë–£–ö–í</code></p>`;
    } else {
      fetch("library.json")
        .then(res => res.json())
        .then(library => {
          const docPath = library[book]?.sections?.[section];
          if (!docPath) {
            document.body.innerHTML = `<p style="padding:40px;">–†–∞–∑–¥–µ–ª "${section}" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–±–æ—Ä–Ω–∏–∫–µ "${book}".</p>`;
            return;
          }

          fetch(docPath)
            .then(response => response.arrayBuffer())
            .then(arrayBuffer => mammoth.extractRawText({ arrayBuffer }))
            .then(result => {
              const blocks = result.value.split("***").map(b => b.trim()).filter(b => b.length > 0);
              const coverMap = {
                "–ú–û–ó–ê–ò–ö–ê –ë–£–ö–í": "mozaikabukv.jpg",
                "–ö–ê–õ–ï–ù–î–ê–†–¨": "calendar.jpg",
                "–°–ï–ì–û–î–ù–Ø –ë–´–õ–ê –í–û–ô–ù–ê": "war.jpg"
              };
              const coverPath = `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/${coverMap[book] || "placeholder.jpg"}`;
              const illustrationPath = `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/${normalizeTitle(section)}-illustration.jpg`;

              document.getElementById("sidebar").innerHTML = `
                <img src="${coverPath}" style="max-width:200px; border-radius:6px;" onerror="this.src='–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/placeholder.jpg'">
                <h2>${section}</h2>
                <ul class="poem-list">
                  ${blocks.map((b, i) => `<li onclick="showPoem(${i})">${extractTitle(b)}</li>`).join("")}
                </ul>
              `;

              document.getElementById("content").innerHTML = `
                <img src="${illustrationPath}" class="section-image" onerror="this.style.display='none'">
                <div id="poem-text"><p class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏—Ö –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞</p></div>
              `;

              document.getElementById("media").innerHTML = `
                <div id="audio-block"><p class="placeholder">–ê–£–î–ò–û –§–ê–ô–õ –û–¢–°–£–¢–°–¢–í–£–ï–¢</p></div>
                <div id="video-block"><p class="placeholder">–í–ò–î–ï–û –§–ê–ô–õ –û–¢–°–£–¢–°–¢–í–£–ï–¢</p></div>
              `;

              window.showPoem = function(index) {
                const poemText = blocks[index];
                const title = extractTitle(poemText);
                document.getElementById("poem-text").innerHTML = `
                  <div class="poem-container">
                    <div class="poem-background"></div>
                    <div class="poem-content">
                      <h3>${title}</h3>
                      <pre>${poemText}</pre>
                    </div>
                  </div>
                `;

                // –ü–æ–¥–≥–æ–Ω–∫–∞ –≤—ã—Å–æ—Ç—ã –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
                setTimeout(() => {
                  const container = document.querySelector(".poem-container");
                  const bg = container?.querySelector(".poem-background");
                  const content = container?.querySelector(".poem-content");
                  if (bg && content) {
                    bg.style.height = content.offsetHeight + "px";
                  }
                }, 50);

                const mediaTitle = normalizeTitle(title);
                checkMedia(`audio/${mediaTitle}.mp3`, "audio-block", "–ê–£–î–ò–û –§–ê–ô–õ –û–¢–°–£–¢–°–¢–í–£–ï–¢", "audio");
                checkMedia(`video/${mediaTitle}.mp4`, "video-block", "–í–ò–î–ï–û –§–ê–ô–õ –û–¢–°–£–¢–°–¢–í–£–ï–¢", "video");
              };

              function extractTitle(text) {
                const lines = text.split("\n").map(l => l.trim()).filter(l => l.length > 0);
                const filtered = lines.filter(line => !/^\/.*\/$/.test(line));
                return filtered[0] || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
              }

              function normalizeTitle(title) {
                return title.toLowerCase().replace(/[^–∞-—èa-z0-9]/gi, "-");
              }

              function checkMedia(path, blockId, fallback, type)
                         function checkMedia(path, blockId, fallback, type) {
                fetch(path).then(res => {
                  if (res.ok) {
                    document.getElementById(blockId).innerHTML =
                      type === "audio"
                        ? `<audio controls src="${path}"></audio>`
                        : `<video controls src="${path}"></video>`;
                  } else {
                    document.getElementById(blockId).innerHTML = `<p class="placeholder">${fallback}</p>`;
                  }
                }).catch(() => {
                  document.getElementById(blockId).innerHTML = `<p class="placeholder">${fallback}</p>`;
                });
              }
            })
            .catch(err => {
              document.body.innerHTML = `<p style="padding:40px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${err.message}</p>`;
            });
        })
        .catch(() => {
          document.body.innerHTML = `<p style="padding:40px;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É.</p>`;
        });
    }

    // üîí –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞
    document.addEventListener("contextmenu", e => {
      if (e.target.closest("pre, h3")) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
